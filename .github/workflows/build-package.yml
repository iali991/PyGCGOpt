name: Build Package

env:
  version: 8.0.0

on: [push]

jobs:
  Build-Package-Linux:
    runs-on: ubuntu-20.04
    steps:
      - name: Cache SCIPOptSuite Package
        uses: actions/cache@v2
        with:
          path: ~/SCIPOptSuite-${{ env.version }}-Linux-ubuntu.deb
          key: ${{ runner.os }}-SCIPOptSuite-${{ env.version }}-home

      - name: Install dependencies (SCIPOptSuite)
        run: |
          wget --timestamping --directory-prefix=$HOME https://scipopt.org/download/release/SCIPOptSuite-${{ env.version }}-Linux-ubuntu.deb
          sudo apt-get install -y pandoc ~/SCIPOptSuite-${{ env.version }}-Linux-ubuntu.deb

      - name: Check out repository code
        uses: actions/checkout@v2
        
      - name: Set up Python 3.9
        uses: actions/setup-python@v2
        with:
          python-version: '3.9'
          cache: 'pip'
          cache-dependency-path: |
            requirements.txt
            docs/requirements.txt

      - name: Prepare Python Environment
        run: |
          pip install -r requirements.txt
          pip install -r docs/requirements.txt

      - name: Checkout PySCIPOpt
        uses: actions/checkout@v2
        with:
          repository: scipopt/PySCIPOpt.git
          ref: scip-8
          path: PySCIPOpt
      - run: echo "PySCIPOpt_HASH=$(cd PySCIPOpt && git rev-parse HEAD)" >> $GITHUB_ENV
      
      - name: Cache PySCIPOpt Build
        uses: actions/cache@v2
        with:
          path: ~/PySCIPOpt_dist
          key: ${{ runner.os }}-PySCIPOpt-${{ env.PySCIPOpt_HASH }}
      
      - name: Build & Install PySCIPOpt
        run: |
          [ ! -f ~/PySCIPOpt_dist/*.whl ] && pip install wheel && python -m build --no-isolation --wheel --outdir ~/PySCIPOpt_dist/ PySCIPOpt/
          pip install ~/PySCIPOpt_dist/*.whl
      
      - name: Build PyGCGOpt
        run: |
          python -m build --sdist --no-isolation --outdir dist/

      - name: Install PyGCGOpt
        run: |
          pip install dist/*.tar.gz
      
      - name: Build Documentation
        run: make html
        working-directory: ./docs
      
      - name: Checkout Documentation Branch
        uses: actions/checkout@v2
        with:
          ref: gh-pages
          path: gh-pages
        
      - name: Deploy Documentation
        run: |
          rm -rf gh-pages/*
          cp -r docs/_build/html/* gh-pages/
          cd gh-pages
          git config user.name "GCG CI Bot"
          git config user.email "noreply@or.rwth-aachen.de"
          git add .
          git commit --allow-empty -m "Deploy docs to GitHub Pages, GitHub Actions build: ${GITHUB_RUN_ID}" -m "Commit: ${GITHUB_SHA}"
          git push

      - name: Archive Documentation
        uses: actions/upload-artifact@v2
        with:
          name: sphinx-documentation
          path: docs/_build/html
